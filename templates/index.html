<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dark Themed Data Visualization Platform</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>

    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Data Sensei</title>
        <style>
            body {
                background-color: #1e1e2d;
                font-family: 'Arial', sans-serif;
                color: #ccc;
                margin: 0;
                padding: 0;
                height: 100vh;
                overflow: hidden;
            }
    
            .container {
                display: flex;
                flex-direction: column;
                height: 100%;
                max-width: 1400px;
                margin: 0 auto;
                background-color: #2a2a3c;
                padding: 10px;
                border-radius: 8px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            }
    
            .navbar {
                margin-bottom: 10px;
            }
    
            .description-box {
                background-color: #2e2e40;
                padding: 15px;
                border-radius: 5px;
                margin-bottom: 10px;
                border: 1px solid #444;
            }
    
            .main-layout {
                display: flex;
                flex-grow: 1;
                gap: 20px;
                overflow: hidden;
            }
    
            .file-upload-section {
                text-align: right;
                margin-bottom: 10px;
            }
    
            .upload-btns {
                margin-top: 10px;
            }
    
            .btn-custom {
                border-radius: 8px;
                padding: 10px 20px;
                font-weight: 600;
                width: 200px;
            }
    
            .btn-primary {
                background-color: #6a0dad;
                border-color: #6a0dad;
            }
    
            .btn-primary:hover {
                background-color: #9a34f7;
            }
    
            .data-area {
                flex: 0.5;
                max-height: 100%;
                overflow-y: auto;
                border: 1px solid #444;
                border-radius: 5px;
                background-color: #2e2e40;
                padding: 10px;
            }
    
            .tab-content-area {
                flex: 0.5;
                display: flex;
                flex-direction: column;
                border: 1px solid #444;
                border-radius: 5px;
                background-color: #2e2e40;
                padding: 10px;
                overflow: hidden;
            }
    
            .nav-tabs {
                margin-bottom: 10px;
            }
    
            .nav-tabs .nav-link {
                color: #ccc;
            }
    
            .nav-tabs .nav-link.active {
                background-color: #6a0dad;
                color: #fff;
            }
    
            .tab-pane {
                flex-grow: 1;
                overflow: hidden;
                color: #ccc;
            }
    
            table {
                width: 100%;
                border-collapse: collapse;
            }
    
            th,
            td {
                padding: 8px;
                border: 1px solid #444;
            }
    
            th {
                background-color: #3a3a52;
                font-weight: bold;
            }
    
            .query-bar-container {
                margin-bottom: 10px;
            }
    
            .query-bar {
                display: flex;
                justify-content: flex-start;
            }
    
            .query-input {
                flex-grow: 1;
                border-radius: 5px;
                padding: 10px;
                border: 1px solid #555;
                margin-right: 10px;
                background-color: #2a2a3c;
                color: #fff;
            }
    
            .chart-type-section {
                margin-top: 20px;
                display: flex;
                align-items: center;
            }
    
            .scrollable-graph {
                max-height: 300px;
                overflow-y: auto;
                flex-grow: 1;
            }
    
            canvas {
                max-width: 100%;
                max-height: 400px;
            }
    
            .tabs-container {
                overflow-y: auto;
                max-height: 80%;
            }
    
            .checkbox-dropdown {
                display: none;
                position: absolute;
                z-index: 1;
                background-color: #2e2e40;
                border-radius: 5px;
                border: 1px solid #444;
                max-height: 200px;
                overflow-y: auto;
            }
    
            .dropdown:hover .checkbox-dropdown {
                display: block;
            }
    
            .pagination {
                display: flex;
                justify-content: center;
                margin-top: 10px;
            }
    
            .page-item {
                margin: 0 5px;
                cursor: pointer;
            }
    
            .page-item.active {
                font-weight: bold;
            }
    
            .page-link {
                padding: 5px 10px;
                border: 1px solid #444;
                border-radius: 5px;
                background-color: #3a3a52;
                color: #fff;
                text-decoration: none;
            }
    
            .page-link:hover {
                background-color: #6a0dad;
            }

            #loading-indicator {
    display: flex;
    flex-direction: column;
    align-items: center; /* Center content horizontally */
    justify-content: center; /* Center content vertically */
    margin-top: 40px; /* Space above */
}

.spinner {
    border: 4px solid rgba(255, 255, 255, 0.3);
    border-top: 4px solid #007bff; /* Customize the spinner color */
    border-radius: 50%;
    width: 30px;
    height: 30px;
    animation: spin 1s linear infinite; /* Spinner animation */
}

/* Animation for spinner */
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Optional: Style the cancel button */
#cancel-btn {
    margin-top: 10px; /* Space above the cancel button */
}
        </style>
    </head>
    
    <body>
        <div class="container">
            <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
                <a class="navbar-brand" href="#">Data Sensei</a>
            </nav>
    
            <div class="description-box">
                <h5>About Data Sensei</h5>
                <p>
                    Data Sensei is an intuitive platform designed for seamless data visualization and analysis. 
                    Upload your data files and create insightful visualizations effortlessly.
                </p>
                <p>
                    For support, visit our <a href="https://support.example.com" style="color: #6a0dad;">support page</a>.
                </p>
            </div>
    
            <div class="file-upload-section">
                <input type="file" id="file" accept=".csv,.xlsx" class="form-control" style="width:200px; margin-bottom: 10px;">
                <div class="upload-btns">
                    <button id="upload-btn" class="btn btn-primary btn-custom">UPLOAD</button>
                </div>
            </div>
    
            <div class="main-layout">
                <div class="data-area" id="data-table">
                    <div id="imported-data"></div>
                    <!-- Pagination Controls -->
                    <div class="pagination" id="pagination-controls">
                        <span class="page-item" id="prev-page" style="display: none;">&lt; Prev</span>
                        <span class="page-item active" id="current-page">1</span>
                        <span class="page-item" id="next-page" style="display: none;">Next &gt;</span>
                    </div>
                </div>
    
                <div class="tab-content-area">
                    <div class="query-bar-container">
                        <div class="query-bar">
                            <input type="text" class="query-input" placeholder="TYPE YOUR QUERY" />
                            <button id="enter-btn" class="btn btn-primary">ENTER</button>
                        </div>
                    </div>
    
                    <ul class="nav nav-tabs" id="tabMenu" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" id="query-tab" data-toggle="tab" href="#query-results" role="tab" aria-controls="query-results" aria-selected="true">Query Results</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="graphs-tab" data-toggle="tab" href="#graph-section" role="tab" aria-controls="graph-section" aria-selected="false">Graphs</a>
                        </li>
                    </ul>
    
                    <div class="tab-content tabs-container">
                                    <div class="tab-pane fade show active" id="query-results" role="tabpanel" aria-labelledby="query-tab">
                            <div id="query-results-content">QUERY RESULTS</div>
                            <div id="loading-indicator" style="display: none;">
                                <div class="spinner"></div>
                                <p>Processing query...</p>
                                <button id="cancel-btn" class="btn btn-danger" style="margin-top: 10px;">CANCEL</button>
                            </div>
                            
                        </div>
    
                        <div class="tab-pane fade" id="graph-section" role="tabpanel" aria-labelledby="graphs-tab">
                            <div class="chart-type-section">
                                <h5>Select Columns to Visualize:</h5>
                                <div class="dropdown">
                                    <button class="btn btn-primary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                        Select Columns
                                    </button>
                                    <div class="checkbox-dropdown dropdown-menu" aria-labelledby="dropdownMenuButton">
                                        <div id="column-selection"></div>
                                    </div>
                                </div>
    
                                <select id="chart-type" class="form-control mx-2" style="width: 150px;">
                                    <option value="line">Line</option>
                                    <option value="bar">Bar</option>
                                    <option value="pie">Pie</option>
                                    <option value="radar">Radar</option>
                                </select>
    
                                <button id="draw-chart" class="btn btn-primary mt-2">Draw Chart</button>
                            </div>
                            <div class="scrollable-graph">
                                <canvas id="chartCanvas"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>


    <script> 
        let chartData = [];
        let headers = [];
        const resultsPerPage = 200; // Number of results to show per page
    
        document.addEventListener('DOMContentLoaded', function () {
            const uploadBtn = document.getElementById('upload-btn');
            const fileInput = document.getElementById('file');
            const importedDataDiv = document.getElementById('imported-data');
            const columnSelectionDiv = document.getElementById('column-selection');
            const drawChartBtn = document.getElementById('draw-chart');
            const chartCanvas = document.getElementById('chartCanvas');
            const enterBtn = document.getElementById('enter-btn');
            const queryResultsContent = document.getElementById('query-results-content');
            const queryInput = document.querySelector('.query-input');
    
            // Event Listener for file upload
            uploadBtn.addEventListener('click', async () => {
                const file = fileInput.files[0];
                if (!file) return;
    
                const fileExt = file.name.split('.').pop().toLowerCase();
                const reader = new FileReader();
    
                reader.onload = async (e) => {
                    const data = e.target.result;
    
                    // Parsing the file based on its type
                    if (fileExt === 'csv') {
                        const parsedData = Papa.parse(data, { header: true });
                        headers = parsedData.meta.fields;
                        chartData = parsedData.data;
                    } else if (fileExt === 'xlsx') {
                        const workbook = XLSX.read(data, { type: 'binary' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const parsedData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                        headers = parsedData[0];
                        chartData = parsedData.slice(1).map(row => {
                            return headers.reduce((obj, key, index) => {
                                obj[key] = row[index] !== undefined ? row[index] : null; // Handle empty cells
                                return obj;
                            }, {});
                        });
                    }
    
                    if (chartData.length > 0) {
                        displayImportedData();
                        populateColumnSelection();
                    } else {
                        alert('No valid data found in the uploaded file.');
                    }
                };
    
                if (fileExt === 'csv') {
                    reader.readAsText(file);
                } else if (fileExt === 'xlsx') {
                    reader.readAsBinaryString(file);
                }
            });

            function processData(results) {
            // Hide loading indicator
            document.getElementById("loading-indicator").style.display = "none";

            const data = results.data;
            displayData(data);
            initializePagination(data);
            }
    
            function displayImportedData() {
                let html = '<table><thead><tr>';
                headers.forEach(header => {
                    html += `<th>${header}</th>`;
                });
                html += '</tr></thead><tbody>';
                chartData.forEach(row => {
                    html += '<tr>';
                    headers.forEach(header => {
                        html += `<td>${row[header] !== undefined ? row[header] : ''}</td>`; // Handle undefined values
                    });
                    html += '</tr>';
                });
                html += '</tbody></table>';
                importedDataDiv.innerHTML = html;
            }
    
            function populateColumnSelection() {
                columnSelectionDiv.innerHTML = ''; // Clear existing options
                headers.forEach(header => {
                    const checkbox = document.createElement('div');
                    checkbox.innerHTML = `
                        <label>
                            <input type="checkbox" value="${header}" class="column-checkbox">
                            ${header}
                        </label>`;
                    columnSelectionDiv.appendChild(checkbox);
                });
            }
    
            drawChartBtn.addEventListener('click', () => {
                const selectedColumns = Array.from(document.querySelectorAll('.column-checkbox:checked')).map(checkbox => checkbox.value);
                const chartType = document.getElementById('chart-type').value;
    
                if (selectedColumns.length < 2) {
                    alert('Please select at least two columns to visualize.');
                    return;
                }
    
                const labels = chartData.map(row => row[selectedColumns[0]]);
                const datasets = selectedColumns.slice(1).map((column, index) => {
                    return {
                        label: column,
                        data: chartData.map(row => row[column] !== undefined ? row[column] : null), // Handle undefined values for chart data
                        borderColor: `hsl(${(index * 360) / selectedColumns.length}, 100%, 50%)`,
                        backgroundColor: `hsl(${(index * 360) / selectedColumns.length}, 100%, 50%, 0.5)`
                    };
                });
    
                const ctx = chartCanvas.getContext('2d');
                new Chart(ctx, {
                    type: chartType,
                    data: {
                        labels: labels,
                        datasets: datasets,
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                    }
                });
            });
    
            async function sendQueryToOpenAI(query) {
                const apiKey = 'sk-O2DXLFWl0Rni51DT9wQaVhJGlM5GrBt2jBYSowW1AsT3BlbkFJnuaFnaViuJajhdIeMcc5m0w0sXNleXpKbzIDLMzeQA'; // Replace with your API key
                const segmentResults = [];
                const segmentSize = Math.ceil(chartData.length * 0.05); // Calculate 5% of the data length
    
                // Segment the data
                const segments = [];
                for (let i = 0; i < chartData.length; i += segmentSize) {
                    segments.push(chartData.slice(i, i + segmentSize));
                }

    
                // Query each segment individually
                for (const segment of segments) {
                    const context = JSON.stringify(segment);
                    const fullQuery = `User query: ${query}\nData context: ${context}`;
    
                    try {
                        const response = await fetch('https://api.openai.com/v1/chat/completions', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${apiKey}`,
                            },
                            body: JSON.stringify({
                                model: 'gpt-4o-mini',
                                messages: [{ role: 'user', content: fullQuery }],
                            }),
                        });
    
                        if (!response.ok) {
                            const errorData = await response.json();
                            console.error('Error response:', errorData);
                            throw new Error(`OpenAI API error: ${errorData.error ? errorData.error.message : 'Unknown error'}`);
                        }
    
                        const data = await response.json();
                        segmentResults.push(data.choices[0].message.content);
                    } catch (error) {
                        console.error('Error in API call for segment:', error);
                        alert('An error occurred while querying OpenAI for a segment. Check console for details.');
                        return; // Exit if an error occurs
                    }
                }
    
                // Combine segment results and query again
                const combinedResponse = segmentResults.join('\n');
                return await sendFinalQueryToOpenAI(query, combinedResponse);
            }
    
            async function sendFinalQueryToOpenAI(initialQuery, combinedResponse) {
                const apiKey = 'sk-O2DXLFWl0Rni51DT9wQaVhJGlM5GrBt2jBYSowW1AsT3BlbkFJnuaFnaViuJajhdIeMcc5m0w0sXNleXpKbzIDLMzeQA'; // Replace with your API key
                const fullQuery = `User query: ${initialQuery}\nCombined data context: ${combinedResponse}`;
    
                try {
                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`,
                        },
                        body: JSON.stringify({
                            model: 'gpt-4o-mini',
                            messages: [{ role: 'user', content: fullQuery }],
                        }),
                    });
    


                    if (!response.ok) {
                        const errorData = await response.json();
                        console.error('Error response:', errorData);
                        throw new Error(`OpenAI API error: ${errorData.error ? errorData.error.message : 'Unknown error'}`);
                    }
    
                    const data = await response.json();
                    return data.choices[0].message.content;
                } catch (error) {
                    console.error('Error in final API call:', error);
                    alert('An error occurred while querying OpenAI. Check console for details.');
                }
            }
    

 // Create an AbortController for canceling the fetch request
let controller;

// Event listener for the Enter button
enterBtn.addEventListener('click', async () => {
    const query = queryInput.value;
    if (!query) return;

    // Show loading animation
    const loadingIndicator = document.getElementById('loading-indicator');
    loadingIndicator.style.display = 'flex'; // Show loading indicator

    // Initialize the AbortController
    controller = new AbortController();

    try {
        // Fetch data with the abort signal
        const finalResponse = await sendQueryToOpenAI(query, { signal: controller.signal });

        // Format the response
        const formattedResponse = formatResponse(finalResponse);
        queryResultsContent.innerHTML = formattedResponse; // Use formatted response for display
    } catch (error) {
        // Check if the error is due to an abort
        if (error.name === 'AbortError') {
            console.log('Query was canceled.');
            // Clear previous results immediately upon cancellation
            queryResultsContent.innerHTML = ''; // Clear previous results
        } else {
            console.error('Error:', error);
            alert('An error occurred while processing your request. Please check the console for details.');
        }
    } finally {
        // Hide loading animation
        loadingIndicator.style.display = 'none'; // Hide loading indicator after the response is received or canceled
    }
});

// Cancel the ongoing query
document.getElementById('cancel-btn').addEventListener('click', () => {
    if (controller) {
        controller.abort(); // Abort the fetch request
        // Hide the loading indicator and clear the results immediately upon cancellation
        const loadingIndicator = document.getElementById('loading-indicator');
        loadingIndicator.style.display = 'none'; // Immediately hide the loading indicator
        queryResultsContent.innerHTML = ''; // Clear any existing results immediately upon cancellation
        console.log('Cancel button clicked. Aborting the request and hiding the loading indicator...');
    }
});

// Function to format the API response for better readability
function formatResponse(response) {
    // Example formatting: wrap in a div and use paragraph tags for clarity
    return `
        <div class="response-container">
            <h3></h3>
            <p>${response.replace(/\n/g, '</p><p>')}</p>
        </div>
    `;
}

        });
    </script>
    
    
    

</body>

</html>


